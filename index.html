window.__APP_LOADED = true;

const $ = (id) => document.getElementById(id);

const questionEl = $("question");
const choicesEl = $("choices"); // Êàë‰ª¨Áî®ÂÆÉÊù•Êîæ‚ÄúÁ≠îÊ°àÂàóË°®‚Äù
const progressTextEl = $("progressText");
const scoreTextEl = $("scoreText");
const prevBtn = $("prevBtn");
const nextBtn = $("nextBtn");
const restartBtn = $("restartBtn");
const resultEl = $("result");

const speakBtn = $("speakBtn");
const stopSpeakBtn = $("stopSpeakBtn");
const rateSelect = $("rateSelect");

const questionsRaw = Array.isArray(window.QUESTIONS) ? window.QUESTIONS : [];

let index = 0;
let revealedByQ = {};      // ÊòØÂê¶Â∑≤ÊòæÁ§∫Á≠îÊ°à
let markedByQ = {};        // 1=correct, 0=wrong
let score = 0;

// ---------- TTS ----------
let cachedVoice = null;

function pickEnglishVoice() {
  const voices = window.speechSynthesis?.getVoices?.() || [];
  return (
    voices.find(v => /en-US/i.test(v.lang)) ||
    voices.find(v => /^en/i.test(v.lang)) ||
    null
  );
}

function ensureVoicesReady() {
  if (!("speechSynthesis" in window)) return;
  cachedVoice = pickEnglishVoice();
  if (!cachedVoice) {
    window.speechSynthesis.onvoiceschanged = () => {
      cachedVoice = pickEnglishVoice();
    };
  }
}

function stopSpeaking() {
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
}

function speakText(text) {
  if (!("speechSynthesis" in window)) {
    alert("Your browser does not support text-to-speech. Try Chrome/Edge.");
    return;
  }
  stopSpeaking();

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-US";
  const rate = Number(rateSelect?.value || 1);
  utter.rate = isNaN(rate) ? 1 : rate;

  const v = cachedVoice || pickEnglishVoice();
  if (v) utter.voice = v;

  window.speechSynthesis.speak(utter);
}

// ---------- Data normalize ----------
function normalize(item) {
  // ‰Ω†Áé∞Âú®ÁöÑÁªìÊûÑÔºö { en, answers_en: [...] }
  // ÂÖºÂÆπÔºöÂ¶ÇÊûúÊúâ‰∫∫Áî® { q, a } ‰πüËÉΩË∑ë
  const q = item.en ?? item.q ?? "";
  const answers = Array.isArray(item.answers_en) ? item.answers_en
                : (item.a ? [item.a] : []);
  const star = !!item.star;
  return { q, answers, star };
}

const questions = questionsRaw.map(normalize);

// ---------- Quiz logic ----------
function computeScore() {
  let s = 0;
  Object.keys(markedByQ).forEach((k) => {
    if (markedByQ[k] === 1) s++;
  });
  return s;
}

function updateTopBar() {
  progressTextEl.textContent = `Question ${index + 1} of ${questions.length || 0}`;
  scoreTextEl.textContent = `Score: ${score}`;
}

function render() {
  if (!questions.length) {
    questionEl.textContent = "‚ùå No questions found. Check questions.js and make sure it ends with: window.QUESTIONS = QUESTIONS;";
    choicesEl.innerHTML = "";
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    return;
  }

  const q = questions[index];
  questionEl.textContent = q.star ? `‚òÖ ${q.q}` : q.q;

  const revealed = !!revealedByQ[index];
  const marked = markedByQ[index]; // 1/0/undefined

  // controls
  prevBtn.disabled = (index === 0);
  nextBtn.disabled = (marked === undefined) || (index >= questions.length - 1);
  restartBtn.style.display = "none";
  resultEl.style.display = "none";

  // answer area (reuse choicesEl)
  if (!revealed) {
    choicesEl.innerHTML = `
      <div class="result" style="display:block;">
        <button id="revealBtn" class="btn">Reveal Answer</button>
        <div class="muted" style="margin-top:10px;">After revealing, mark yourself correct or wrong to unlock Next.</div>
      </div>
    `;
    const revealBtn = document.getElementById("revealBtn");
    revealBtn.addEventListener("click", () => {
      revealedByQ[index] = true;
      render();
    });
    return;
  }

  // revealed answers
  const answersHtml = q.answers.length
    ? `<ol style="margin:10px 0 0; padding-left:18px;">
         ${q.answers.map(a => `<li style="margin:6px 0;">${a}</li>`).join("")}
       </ol>`
    : `<div class="muted" style="margin-top:10px;">(No answer listed.)</div>`;

  const correctActive = marked === 1 ? " style='outline:2px solid rgba(43,213,118,.6)'" : "";
  const wrongActive = marked === 0 ? " style='outline:2px solid rgba(255,90,122,.6)'" : "";

  choicesEl.innerHTML = `
    <div class="result" style="display:block;">
      <div class="muted">Acceptable answers:</div>
      ${answersHtml}
      <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px;">
        <button id="speakAnswerBtn" class="btn secondary">üîä Speak Answer</button>
        <button id="markCorrectBtn" class="btn"${correctActive}>I was correct ‚úÖ</button>
        <button id="markWrongBtn" class="btn secondary"${wrongActive}>I was wrong ‚ùå</button>
      </div>
    </div>
  `;

  document.getElementById("speakAnswerBtn").addEventListener("click", () => {
    const text = q.answers.length ? q.answers.join(". ") : "No answer listed.";
    speakText(text);
  });

  document.getElementById("markCorrectBtn").addEventListener("click", () => {
    markedByQ[index] = 1;
    score = computeScore();
    render();
    updateTopBar();
  });

  document.getElementById("markWrongBtn").addEventListener("click", () => {
    markedByQ[index] = 0;
    score = computeScore();
    render();
    updateTopBar();
  });
}

function showResult() {
  const finalScore = computeScore();
  score = finalScore;

  resultEl.style.display = "block";
  resultEl.innerHTML = `
    <strong>Finished!</strong><br/>
    Correct: <strong>${finalScore}</strong> / <strong>${questions.length}</strong><br/>
    Accuracy: <strong>${Math.round((finalScore / questions.length) * 100)}%</strong>
  `;

  restartBtn.style.display = "inline-block";
  nextBtn.disabled = true;
}

function goPrev() {
  stopSpeaking();
  if (index > 0) {
    index--;
    render();
    updateTopBar();
  }
}

function goNext() {
  stopSpeaking();
  if (index < questions.length - 1) {
    index++;
    render();
    updateTopBar();
  } else {
    showResult();
  }
}

function restart() {
  stopSpeaking();
  index = 0;
  revealedByQ = {};
  markedByQ = {};
  score = 0;
  render();
  updateTopBar();
}

// Buttons
prevBtn.addEventListener("click", goPrev);
nextBtn.addEventListener("click", goNext);
restartBtn.addEventListener("click", restart);

speakBtn.addEventListener("click", () => {
  if (!questions.length) return;
  speakText(questions[index].q);
});
stopSpeakBtn.addEventListener("click", stopSpeaking);

// Init
ensureVoicesReady();
updateTopBar();
render();
